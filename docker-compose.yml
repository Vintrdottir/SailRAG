services:
  opensearch:
    image: opensearchproject/opensearch:2.13.0
    container_name: sailrag-opensearch
    environment:
      - discovery.type=single-node
      - OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g
      - plugins.security.disabled=true
      - OPENSEARCH_INITIAL_ADMIN_PASSWORD=R4g!Sail_2025#A9xQ #no, it's not prod security
      # dev-friendly: in prod I would enable TLS + security plugin
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - opensearch-data:/usr/share/opensearch/data
    ports:
      - "9200:9200"
      - "9600:9600" # performance analyzer
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:9200 >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30

  ollama:
    image: ollama/ollama:latest
    container_name: sailrag-ollama
    volumes:
      - ollama-data:/root/.ollama
    ports:
      - "11434:11434"
    healthcheck:
      test: ["CMD", "ollama", "list"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 20s

  backend:
    build:
      context: ./backend
    container_name: sailrag-backend
    env_file:
      - .env
    environment:
      # override/ensure inside compose network
      - OPENSEARCH_URL=http://opensearch:9200
      - OLLAMA_URL=http://ollama:11434
    ports:
      - "8000:8000"
    depends_on:
      opensearch:
        condition: service_healthy
      ollama:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8000/healthz >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30

  ui:
    build:
      context: ./ui
    container_name: sailrag-ui
    env_file:
      - .env
    environment:
      - BACKEND_URL=http://backend:8000
    ports:
      - "8501:8501"
    depends_on:
      backend:
        condition: service_healthy

volumes:
  opensearch-data:
  ollama-data:
